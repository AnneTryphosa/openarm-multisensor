# Muscle Time Series Data Aggregation, Analysis, & Deformation Tracking

This repo contains code used to 
- import, manipulate, and visualize muscle time series data, including ultrasound, surface electromyography (sEMG), acoustic myography (AMG), and output force data streams; and
- track muscle deformation (i.e., contour motion) using optical flow from time series ultrasound frames.

**If you use this code for academic purposes, please cite the following publication**: Laura A. Hallock, Akash Velu, Amanda Schwartz, and Ruzena Bajcsy, "[Muscle deformation correlates with output force during isometric contraction](https://people.eecs.berkeley.edu/~lhallock/publication/hallock2020biorob/)," in _IEEE RAS/EMBS International Conference on Biomedical Robotics & Biomechatronics (BioRob)_, IEEE, 2020.

This README primarily describes the methods needed to recreate the analyses described in the publication above, as applied to the time series "multisensor" data found in the [OpenArm repository](https://simtk.org/frs/?group_id=1617). The code and documentation are provided as-is; however, we invite anyone who wishes to adapt and use it under a [Creative Commons Attribution 4.0 International License](https://creativecommons.org/licenses/by/4.0/).

---

## Installation

All packages used in code development and their associated versions can be found in [`requirements.txt`](requirements.txt); however, many of these packages relate to our formatting, linting, and testing procedures and are unnecessary for non-developers. For simply running the code, the following Python modules are required, all of which can be installed via `pip`: `matplotlib`, `numpy`, `opencv-python`, `pandas`, `scipy`, and `seaborn`. 

---

## Time series data aggregation, analysis, and plotting

This section describes the file structure and code necessary to recreate all plots and statistics in the publication above. Two main scripts are included: the first, [`run_multisensorimport.py`](run_multisensorimport.py) aggregates and plots all time series force, sEMG, and ultrasound-based deformation data, and writes out correlation tables to CSV; the second, [`gen_pub_figs.py`](gen_pub_figs.py) uses these CSV files and others generated in the deformation tracking procedures below to generate all bar plots and statistics reported in the publication above.

### Setup

Data should be downloaded from the [OpenArm multi-sensor data set](TODO) and arranged as follows:

```bash
.
├── gen_pub_figs.py
├── run_multisensorimport.py
├── sandbox/data/FINAL
│   ├── sub[N]
│   │   ├── seg_data.mat
│   │   ├── wp[i]t[j]
│   │   │   ├── ground_truth_csa.csv
│   │   │   ├── ground_truth_thickness.csv
│   │   │   ├── ground_truth_thickness_ratio.csv
│   │   │   ├── BFLK-G
│   │   │   │   ├── iou_series.csv
│   │   │   │   ├── tracking_csa.csv
│   │   │   │   ├── tracking_thickness.csv
│   │   │   │   └── tracking_thickness_ratio.csv
│   │   │   ├── BFLK-T
│   │   │   │   ├── iou_series.csv
│   │   │   │   ├── ...
│   │   │   ├── FRLK
│   │   │   │   ├── iou_series.csv
│   │   │   │   ├── ...
│   │   │   ├── LK
│   │   │   │   ├── iou_series.csv
│   │   │   │   ├── ...
│   │   │   ├── SBLK-G
│   │   │   │   ├── iou_series.csv
│   │   │   │   ├── ...
│   │   │   └── SBLK-T
│   │   │       ├── iou_series.csv
│   │   │       ├── ...
│   │   ├── ...
│   ├── ...

```

i.e., data should be placed in directory `sandbox/data/FINAL`, where `sandbox` is a directory at the top level of this repository. Alternatively, file paths can be modified via the constant variables at the top of each script.

Note that this file structure is consistent with the released ZIP archive; the high-level folder should simply be copied to the correct location. Some of the included files are raw/archive sensor data, while others are CSV tables generated by the deformation tracking code below. For a full discussion of all files and their origins, consult the README of the [data release](TODO).

### Usage

First, run

```bash
python run_multisensorimport.py
```

to view all time series data plots. This will also generate correlation table files `ang_corr.csv` and `subj_corr.csv` in `sandbox/data/FINAL`, which are necessary for the second script below. (These files are also included with the OpenArm data release; the command above is thus optional if these files are already in the tree.)

Next, run

```bash
python gen_pub_figs.py
```

to view all bar plots and aggregate correlation statistics in the publication above.

---

## Deformation tracking in ultrasound scans
This section describes how to execute muscle deformation tracking via optical flow, and explains how to obtain and organize the necessary data for deformation tracking. There is one runner script for tracking: [`run_multisensorimport.py`](run_multisensorimport.py), which tracks all relevent deformation signals - both ground truth values, and optical-flow calculated values - and outputs the signal time series, as well as tracking error time series, in CSV format. The specific optical flow algorithm to use (LK, FRLK, BFLK, or SBLK) is specified when running this runner script.   

### Setup
Download the ultrasound data from: [TODO], and within this folder, ensure the data is organized in the following manner:

```
├── ultrasound_data
│   ├── sub[N]
│   │   ├── segmented_data
│   │   │   ├── xxx.pgm
│   │   │   ├── ...
│   │   ├── ultrasound_data
│   │   │   ├── xxx.pgm
│   │   │   ├── ...
│   │   ├── ...
│   ├── ...
```
It is critical that within a single sub[N] folder, the segmented_data folder and the ultrasound_data folder contain the same number of .pgm files, with the same names (this is to ensure the ground truth segmented frame matches properly with its corresponding ultrasound frame). 

### Usage
To execute tracking of deformation signals, run the following:
```bash
python run_tracking.py --run_type <run_type> --img_path <path_to_ultrasound_frames> --seg_path <path_to_segmented_frames> --init_img <first_image_number.pgm> --out_path <path_to_output_folder>
```
The command line arguments are described below:
- run_type (int) specifies which optical flow algorithm to use; 1 refers to LK, 2 to FRLK, 3 to BFLK, and 4 to SBLK. 
- path_to_ultrasound_frames (filepath) specifies the path to the folder containing raw ultrasound frames; for example, ```/.../ultrasound_data/sub[N]/ultrasound_data/```
- path_to_segmented_frames (filepath) specifies the path to the folder containing the ground-truth segmented ultrasound frames; for example, 
```/.../ultrasound_data/sub[N]/segmented_data/```
- first_image_number.pgm (filename) specifies the filename of the pgm file containing the first frame in the series of ultrasound frames located in ```ultrasound_data/```. This file will be the pgm file whose name is the smallest number in its respective folder.
- path_to_output_folder (filepath) specifies the path to the folder into which the CSV files will be output. 

### Parameter values
The ```run_tracking.py``` runner script also specifies the values for hyperparameters used throughout the computer vision algorithms for muscle deformation tracking. The currently specified values are defaults; the values at the start of the file can be changed. For a description of the hyperparameters, and for a table specifying the hyperparameter values used for each algorithm and each subject, see (TODO). 
